from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
import struct
import socket

router = APIRouter()
tags_cve_2020_0786 = "cve-2020-0786"

class TargetIPRequest(BaseModel):
    ip_address: str

@router.post("/api/check-vuln-cve-2020-0786", tags=[tags_cve_2020_0786])
async def check_smb_vulnerability(target_ip: TargetIPRequest):
    try:
        # Tạo socket và kết nối đến máy chủ SMB
        sock = socket.socket(socket.AF_INET)
        sock.settimeout(4)
        sock.connect((target_ip.ip_address, 445))

        # Xây dựng gói tin SMB 
        packet = b'\x00\x00\x00\xc0\xfeSMB@\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00$\x00\x08\x00\x01\x00\x00\x00\x7f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00x\x00\x00\x00\x02\x00\x00\x00\x02\x02\x10\x02"\x02$\x02\x00\x03\x02\x03\x10\x03\x11\x03\x00\x00\x00\x00\x01\x00&\x00\x00\x00\x00\x00\x01\x00 \x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x00\n\x00\x00\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00'
        
        # Gửi gói tin 
        sock.send(packet)

        # Nhận và kiểm tra kết quả 
        nb, = struct.unpack(">I", sock.recv(4))
        result = sock.recv(nb)

        if not result[68:70] == b"\x11\x03":
            return "Không bị tổn thương"
        if not result[70:72] == b"\x02\x00":
            return "Không bị tổn thương"

        return "Dễ bị tổn thương"

    except Exception as e:
        return str(e)

